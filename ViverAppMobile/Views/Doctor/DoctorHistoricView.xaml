<?xml version="1.0" encoding="utf-8" ?>
<ContentView
    x:Class="ViverAppMobile.Views.Doctor.DoctorHistoricView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:behaviors="clr-namespace:ViverAppMobile.Behaviors"
    xmlns:controls="clr-namespace:ViverAppMobile.Controls"
    xmlns:converter="clr-namespace:ViverAppMobile.Converters"
    xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
    xmlns:vm="clr-namespace:ViverAppMobile.ViewModels.Doctor"
    x:Name="DoctorHistoricPage"
    BackgroundColor="{StaticResource PageBackground}">

    <ContentView.BindingContext>
        <vm:DoctorHistoricViewModel />
    </ContentView.BindingContext>

    <ContentView.Resources>
        <ResourceDictionary>
            <converter:RatingToStarsConverter x:Key="RatingToStarsConverter" />
            <converter:DateTimeToStringConverter x:Key="DateTimeToStringConveter" CurrentFormat="ddd, dd 'de' MMM 'de' yyyy 'às' HH:mm" />
            <converter:AppointmentTypeToStringConverter x:Key="AppointmentTypeToStringConverter" />
            <converter:AppointmentTypeToColorConverter x:Key="AppointmentTypeToColorConverter" />
            <converter:AppointmentTypeToStringConverter
                x:Key="AppointmentTypeToICONConverter"
                ConsultationText="&#xe811;"
                ExaminationText="&#xe817;"
                SurgeryText="&#xe806;" />
            <converter:SelectedValueToColorConverter
                x:Key="SelectedValueToRatingColorConverter"
                SelectedColor="Black"
                UnselectedColor="Gold" />
        </ResourceDictionary>
    </ContentView.Resources>

    <RefreshView Command="{Binding ReloadPageCommand}" IsRefreshing="{Binding IsReloading}">
        <ScrollView x:Name="MainScroll">
            <VerticalStackLayout Padding="15" Spacing="20">
                <VerticalStackLayout Spacing="6">
                    <Label
                        FontFamily="Semibold"
                        FontSize="16"
                        HorizontalTextAlignment="Center"
                        Text="Atendimentos Realizados" />
                    <Label
                        FontSize="13"
                        HorizontalTextAlignment="Center"
                        Text="Visualize e gerencie laudos dos atendimentos finalizados"
                        TextColor="Gray" />
                </VerticalStackLayout>

                <!--#region Filters-->
                <Border
                    Padding="10"
                    BackgroundColor="White"
                    StrokeShape="8">
                    <toolkit:Expander x:Name="FilterExpander" ExpandedChanged="FilterExpander_ExpandedChanged">
                        <toolkit:Expander.Header>
                            <FlexLayout Direction="Row" JustifyContent="SpaceBetween">
                                <Label FontSize="12">
                                    <Label.FormattedText>
                                        <FormattedString>
                                            <Span FontFamily="AppIcons" Text="&#xe810;" />
                                            <Span Text="  Filtros" />
                                        </FormattedString>
                                    </Label.FormattedText>
                                </Label>
                                <Label
                                    x:Name="FiltersIconLabelExpand"
                                    ClassId="IconLabelExpand"
                                    FontFamily="AppIcons"
                                    FontSize="12"
                                    Text="&#xe80e;"
                                    TextColor="Black" />
                            </FlexLayout>
                        </toolkit:Expander.Header>

                        <toolkit:Expander.Content>
                            <VerticalStackLayout Margin="0,20,0,0" Spacing="10">
                                <Border
                                    Padding="0,-6"
                                    BackgroundColor="{StaticResource BackgroundGray}"
                                    Stroke="Transparent"
                                    StrokeShape="RoundRectangle 8">
                                    <SearchBar
                                        FontSize="13"
                                        Placeholder="Buscar pelo nome do paciente ou nome do serviço...."
                                        PlaceholderColor="Gray"
                                        SearchCommand="{Binding FilterByStringCommand}"
                                        Text="{Binding FilterString}" />
                                </Border>

                                <VerticalStackLayout Spacing="2">
                                    <Label
                                        FontFamily="Semibold"
                                        FontSize="12"
                                        Text="Modalidade" />
                                    <Border
                                        Padding="0,-8"
                                        BackgroundColor="{StaticResource BackgroundGray}"
                                        Stroke="Transparent"
                                        StrokeShape="RoundRectangle 8">
                                        <Picker
                                            FontSize="12"
                                            ItemsSource="{Binding FilterModalityOptions}"
                                            SelectedItem="{Binding SelectedModalityFilter}"
                                            TextColor="Gray" />
                                    </Border>
                                </VerticalStackLayout>

                                <VerticalStackLayout Spacing="2">
                                    <Label
                                        FontFamily="Semibold"
                                        FontSize="12"
                                        Text="Tipo de Atendimento" />
                                    <Border
                                        Padding="0,-8"
                                        BackgroundColor="{StaticResource BackgroundGray}"
                                        Stroke="Transparent"
                                        StrokeShape="RoundRectangle 8">
                                        <Picker
                                            FontSize="12"
                                            ItemsSource="{Binding FilterAppointmentTypes}"
                                            SelectedItem="{Binding SelectedAppointmentTypeFilter}"
                                            TextColor="Gray" />
                                    </Border>
                                </VerticalStackLayout>

                                <Grid ColumnDefinitions="*,*" ColumnSpacing="20">
                                    <StackLayout
                                        Grid.Row="0"
                                        Grid.Column="0"
                                        Spacing="6">
                                        <Label
                                            Margin="2,0,0,0"
                                            FontSize="12"
                                            Text="Data Inicial" />
                                        <Border
                                            Padding="12,4,12,4"
                                            BackgroundColor="{StaticResource BackgroundGray}"
                                            StrokeShape="8"
                                            StrokeThickness="0.5">
                                            <FlexLayout AlignItems="Center">
                                                <controls:FullWidthDatePicker
                                                    BackgroundColor="Transparent"
                                                    Date="{Binding StartDateFilter}"
                                                    FlexLayout.Basis="0%"
                                                    FlexLayout.Grow="1"
                                                    FontSize="12"
                                                    HorizontalOptions="Fill"
                                                    MaximumDate="{Binding EndDateFilter}"
                                                    MinimumWidthRequest="0"
                                                    VerticalOptions="Center">
                                                    <controls:FullWidthDatePicker.Margin>
                                                        <OnPlatform x:TypeArguments="Thickness">
                                                            <On Platform="Android" Value="0" />
                                                            <On Platform="WinUI" Value="-6,0,-6,0" />
                                                        </OnPlatform>
                                                    </controls:FullWidthDatePicker.Margin>
                                                </controls:FullWidthDatePicker>
                                            </FlexLayout>
                                        </Border>
                                    </StackLayout>
                                    <StackLayout
                                        Grid.Row="0"
                                        Grid.Column="1"
                                        Spacing="6">
                                        <Label
                                            Margin="2,0,0,0"
                                            FontSize="12"
                                            Text="Data Final" />
                                        <Border
                                            Padding="12,4,12,4"
                                            BackgroundColor="{StaticResource BackgroundGray}"
                                            StrokeShape="8"
                                            StrokeThickness="0.5">
                                            <FlexLayout AlignItems="Center">
                                                <controls:FullWidthDatePicker
                                                    BackgroundColor="Transparent"
                                                    Date="{Binding EndDateFilter}"
                                                    FlexLayout.Basis="0%"
                                                    FlexLayout.Grow="1"
                                                    FontSize="12"
                                                    HorizontalOptions="Fill"
                                                    MinimumDate="{Binding StartDateFilter}"
                                                    MinimumWidthRequest="0"
                                                    VerticalOptions="Center">
                                                    <controls:FullWidthDatePicker.Margin>
                                                        <OnPlatform x:TypeArguments="Thickness">
                                                            <On Platform="Android" Value="0" />
                                                            <On Platform="WinUI" Value="-6,0,-6,0" />
                                                        </OnPlatform>
                                                    </controls:FullWidthDatePicker.Margin>
                                                </controls:FullWidthDatePicker>
                                            </FlexLayout>
                                        </Border>
                                    </StackLayout>
                                </Grid>

                                <Border
                                    Margin="0,10,0,0"
                                    Padding="6"
                                    Style="{StaticResource MasterBorderStyle}">

                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding ClearFiltersCommand}" />
                                    </Border.GestureRecognizers>

                                    <Label
                                        FontSize="12"
                                        HorizontalTextAlignment="Center"
                                        TextColor="Red">
                                        <Label.FormattedText>
                                            <FormattedString>
                                                <Span FontFamily="AppIcons" Text="&#xe80a;" />
                                                <Span FontFamily="Semibold" Text="  Limpar Filtros" />
                                            </FormattedString>
                                        </Label.FormattedText>
                                    </Label>
                                </Border>
                            </VerticalStackLayout>
                        </toolkit:Expander.Content>
                    </toolkit:Expander>
                </Border>
                <!--#endregion-->

                <!--#region HistoricCollection-->
                <CollectionView ItemsSource="{Binding Historic}">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout ItemSpacing="6" Orientation="Vertical" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.EmptyView>
                        <ContentView
                            x:Name="EmptyBorderHistoric"
                            BindingContext="Ops... Parece que você ainda não concluiu nenhum atendimento."
                            ControlTemplate="{StaticResource EmptyStateTemplate}" />
                    </CollectionView.EmptyView>

                    <CollectionView.Footer>
                        <ActivityIndicator
                            x:Name="LoadingFooterHistoric"
                            HorizontalOptions="Center"
                            IsRunning="True"
                            IsVisible="{Binding HasMoreHistoric}"
                            VerticalOptions="End" />
                    </CollectionView.Footer>

                    <CollectionView.Behaviors>
                        <behaviors:InfiniteScrollBehavior
                            EmptyView="{x:Reference EmptyBorderHistoric}"
                            FooterView="{x:Reference LoadingFooterHistoric}"
                            HasMoreItems="{Binding HasMoreHistoric}"
                            LoadMoreCommand="{Binding LoadMoreHistoricCommand}"
                            TargetScrollView="{x:Reference MainScroll}" />
                    </CollectionView.Behaviors>

                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border
                                Padding="15,10,15,10"
                                Shadow="{StaticResource BottomShadow}"
                                Style="{StaticResource MasterBorderStyle}">
                                <VerticalStackLayout Spacing="14">
                                    <FlexLayout JustifyContent="SpaceBetween">
                                        <VerticalStackLayout Spacing="4">
                                            <Label FontSize="14">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span FontAttributes="Bold" Text="Paciente: " />
                                                        <Span Text="{Binding UserName}" />
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                            <Label
                                                FontSize="12"
                                                Text="{Binding AppointmentTitle}"
                                                TextColor="Gray" />
                                        </VerticalStackLayout>

                                        <Border
                                            Padding="6,3,6,3"
                                            BackgroundColor="{Binding AppointmentType, Converter={StaticResource AppointmentTypeToColorConverter}}"
                                            Stroke="Transparent"
                                            StrokeShape="6"
                                            VerticalOptions="Start">
                                            <Label FontSize="11" TextColor="White">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span FontFamily="AppIcons" Text="{Binding AppointmentType, Converter={StaticResource AppointmentTypeToICONConverter}}" />
                                                        <Span Text="  " />
                                                        <Span Text="{Binding AppointmentType, Converter={StaticResource AppointmentTypeToStringConverter}}" />
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </Border>
                                    </FlexLayout>

                                    <VerticalStackLayout Spacing="4">
                                        <HorizontalStackLayout Spacing="10">
                                            <Label
                                                FontFamily="AppIcons"
                                                FontSize="12"
                                                Text="&#xf133;" />
                                            <Label FontSize="12" Text="{Binding AppointmentDate, Converter={StaticResource DateTimeToStringConveter}}" />
                                        </HorizontalStackLayout>
                                        <HorizontalStackLayout Spacing="11">
                                            <Label
                                                FontFamily="AppIcons"
                                                FontSize="12"
                                                Text="&#xe804;" />
                                            <Label FontSize="12" Text="{Binding UserPhone}" />
                                        </HorizontalStackLayout>
                                    </VerticalStackLayout>

                                    <Border
                                        Padding="10,4,10,4"
                                        BackgroundColor="{StaticResource BackgroundGray}"
                                        Style="{StaticResource MasterBorderStyle}">
                                        <Label
                                            FontSize="11"
                                            LineBreakMode="TailTruncation"
                                            LineHeight="1.3"
                                            MaxLines="2">
                                            <Label.FormattedText>
                                                <FormattedString>
                                                    <Span FontAttributes="Bold" Text="Laudo: " />
                                                    <Span Text="{Binding MedicalReport}" />
                                                </FormattedString>
                                            </Label.FormattedText>
                                        </Label>
                                    </Border>

                                    <FlexLayout JustifyContent="SpaceBetween">
                                        <HorizontalStackLayout Spacing="6">
                                            <Label
                                                FontFamily="AppIcons"
                                                FontSize="6"
                                                Text="&#xf111;"
                                                TextColor="Black"
                                                VerticalTextAlignment="Center" />
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="12"
                                                Text="Avaliação do Paciente:"
                                                VerticalTextAlignment="Center" />
                                            <Label
                                                Margin="0,1.3,0,0"
                                                FontFamily="AppIcons"
                                                FontSize="14"
                                                Text="{Binding Rating, Converter={StaticResource RatingToStarsConverter}}"
                                                TextColor="{Binding Rating, Converter={StaticResource SelectedValueToRatingColorConverter}, ConverterParameter={StaticResource Index0}}"
                                                VerticalTextAlignment="Start" />
                                        </HorizontalStackLayout>

                                        <Border
                                            Padding="6,3,6,3"
                                            BackgroundColor="CornflowerBlue"
                                            Style="{StaticResource MasterBorderStyle}"
                                            VerticalOptions="Start">

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding BindingContext.ShowScheduleFeedbackCommand, Source={x:Reference DoctorHistoricPage}}" CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>

                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="11"
                                                Text="Feedback"
                                                TextColor="White"
                                                TextDecorations="Underline" />
                                        </Border>
                                    </FlexLayout>

                                    <Grid ColumnDefinitions="*,*" ColumnSpacing="6">
                                        <Border
                                            Grid.Column="0"
                                            Padding="10,6,10,6"
                                            StrokeThickness="0.8"
                                            Style="{StaticResource MasterBorderStyle}">

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding BindingContext.ShowMedicalReportCommand, Source={x:Reference DoctorHistoricPage}}" CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>

                                            <Label FontSize="11" HorizontalTextAlignment="Center">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span FontFamily="AppIcons" Text="&#xf0f6;" />
                                                        <Span FontFamily="Semibold" Text="  Laudo Completo" />
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </Border>

                                        <Border
                                            Grid.Column="1"
                                            Padding="10,6,10,6"
                                            StrokeThickness="0.8"
                                            Style="{StaticResource MasterBorderStyle}">

                                            <Border.GestureRecognizers>
                                                <TapGestureRecognizer Command="{Binding BindingContext.ShowAttachmentsCommand, Source={x:Reference DoctorHistoricPage}}" CommandParameter="{Binding .}" />
                                            </Border.GestureRecognizers>

                                            <Label FontSize="11" HorizontalTextAlignment="Center">
                                                <Label.FormattedText>
                                                    <FormattedString>
                                                        <Span FontFamily="AppIcons" Text="&#xe820;" />
                                                        <Span FontFamily="Semibold" Text="  Anexos" />
                                                    </FormattedString>
                                                </Label.FormattedText>
                                            </Label>
                                        </Border>
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <!--#endregion-->
            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>
</ContentView>
